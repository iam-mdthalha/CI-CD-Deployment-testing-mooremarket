name: Release - Create Version Tag

on:
  push:
    branches: 
      - main
  workflow_dispatch: 
    inputs:
      version_type:
        description:  'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents:  write
  pull-requests:  write

jobs: 
  release:
    name: ğŸ·ï¸ Create Release
    runs-on:  ubuntu-latest
    
    # Skip if commit is from release bot
    if: "! contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'chore(release)')"

    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      new_tag: ${{ steps.version.outputs.new_tag }}

    steps:
      - name: Checkout code
        uses:  actions/checkout@v4
        with: 
          fetch-depth:  0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Get current version
        id: current
        run: |
          if [ -f version.json ]; then
            CURRENT_VERSION=$(cat version.json | grep -oE '"version":\s*"[^"]+"' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "0.0.0")
          else
            CURRENT_VERSION="0.0.0"
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name:  Determine version bump type
        id: bump_type
        run:  |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUMP_TYPE="${{ github.event.inputs.version_type }}"
          else
            COMMITS=$(git log --oneline -20)
            
            if echo "$COMMITS" | grep -qiE "BREAKING CHANGE"; then
              BUMP_TYPE="major"
            elif echo "$COMMITS" | grep -qiE "feat: "; then
              BUMP_TYPE="minor"
            else
              BUMP_TYPE="patch"
            fi
          fi
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Bump type: $BUMP_TYPE"

      - name:  Calculate new version
        id: version
        run: |
          CURRENT="${{ steps.current.outputs.current_version }}"
          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          
          # Split version
          MAJOR=$(echo $CURRENT | cut -d.  -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          NEW_TAG="v${NEW_VERSION}"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

      - name: Generate release notes
        run: |
          echo "## ğŸš€ Release ${{ steps.version.outputs.new_tag }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### What's Changed" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" $PREV_TAG.. HEAD >> RELEASE_NOTES.md
          else
            git log --pretty=format:"- %s (%h)" -10 >> RELEASE_NOTES.md
          fi
          
          echo "" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "---" >> RELEASE_NOTES.md
          echo "*Released on $(date +'%Y-%m-%d %H:%M:%S UTC')*" >> RELEASE_NOTES.md
          
          echo "=== Release Notes ==="
          cat RELEASE_NOTES.md

      - name: Create Git tag
        run:  |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
          git push origin ${{ steps.version.outputs.new_tag }}
          
          echo "âœ… Tag ${{ steps.version.outputs.new_tag }} created and pushed"

      - name: Create GitHub Release
        uses:  actions/github-script@v7
        with: 
          github-token:  ${{ secrets.RELEASE_TOKEN }}
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('RELEASE_NOTES.md', 'utf8');
            
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.version.outputs.new_tag }}',
              name: 'Release ${{ steps.version.outputs.new_tag }}',
              body: releaseNotes,
              draft: false,
              prerelease: false
            });
            
            console.log(`âœ… Release created: ${release.data.html_url}`);

      - name: Create version update branch
        run: |
          BRANCH_NAME="release/v${{ steps.version.outputs.new_version }}"
          
          git checkout -b $BRANCH_NAME
          
          # Update version.json
          echo '{"version":  "${{ steps.version.outputs.new_version }}"}' > version.json
          
          # Create/Update CHANGELOG.md
          if [ !  -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # Create temp file with new entry
          echo "" > NEW_ENTRY.md
          echo "## [${{ steps.version. outputs.new_tag }}] - $(date +'%Y-%m-%d')" >> NEW_ENTRY.md
          echo "" >> NEW_ENTRY.md
          
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s" $PREV_TAG..HEAD~1 >> NEW_ENTRY.md || echo "- Release ${{ steps.version.outputs.new_tag }}" >> NEW_ENTRY.md
          else
            echo "- Initial release" >> NEW_ENTRY.md
          fi
          echo "" >> NEW_ENTRY.md
          
          # Merge changelog
          head -4 CHANGELOG.md > TEMP_CL.md
          cat NEW_ENTRY. md >> TEMP_CL.md
          tail -n +5 CHANGELOG. md >> TEMP_CL.md 2>/dev/null || true
          mv TEMP_CL.md CHANGELOG. md
          rm -f NEW_ENTRY.md
          
          git add version.json CHANGELOG.md
          git commit -m "chore(release): update version to ${{ steps.version.outputs.new_version }} [skip ci]"
          git push origin $BRANCH_NAME
          
          echo "âœ… Branch $BRANCH_NAME created and pushed"

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RELEASE_TOKEN }}
          script: |
            const branchName = `release/v${{ steps.version.outputs.new_version }}`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore(release): update version to ${{ steps.version.outputs.new_version }}`,
              head: branchName,
              base: 'main',
              body: `## ğŸ·ï¸ Version Update PR
            
            This PR updates version files after release **${{ steps.version.outputs.new_tag }}**.
            
            ### Changes
            - âœ… Git tag \`${{ steps.version.outputs.new_tag }}\` created
            - âœ… GitHub Release created
            - ğŸ“ \`version.json\` updated to \`${{ steps.version.outputs. new_version }}\`
            - ğŸ“ \`CHANGELOG.md\` updated
            
            ### Action Required
            **Please merge this PR to complete the release process.**
            
            ---
            *This PR was automatically created by the release workflow.*`
            });
            
            console.log(`âœ… PR #${pr.data. number} created:  ${pr.data. html_url}`);

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "        ğŸ‰ RELEASE COMPLETE"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Version:  ${{ steps.version.outputs.new_version }}"
          echo "ğŸ·ï¸  Tag: ${{ steps.version.outputs.new_tag }}"
          echo ""
          echo "âœ… Git tag created"
          echo "âœ… GitHub Release created"
          echo "âœ… Version update PR created"
          echo ""
          echo "ğŸ‘‰ Please merge the PR to update version files"
          echo "=============================================="